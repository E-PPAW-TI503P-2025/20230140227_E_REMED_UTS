<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistem Perpustakaan Geo</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f4f4f9; max-width: 900px; margin: 0 auto; padding: 20px; }
        header { display: flex; justify-content: space-between; align-items: center; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        h1 { margin: 0; font-size: 1.5rem; color: #2c3e50; }
        
        .role-control { text-align: right; }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ddd; }
        
        table { width: 100%; background: white; border-collapse: collapse; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #34495e; color: white; }
        
        /* Buttons */
        .btn { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; color: white; font-size: 0.9em; margin-right: 5px; }
        .btn-borrow { background: #27ae60; } /* Hijau */
        .btn-delete { background: #e74c3c; } /* Merah */
        .btn-add { background: #2980b9; margin-bottom: 15px; padding: 10px 20px; } /* Biru */
        
        .hidden { display: none; }
        #add-form { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; border: 1px solid #ddd; }
        input { padding: 8px; margin-right: 10px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

    <header>
        <div>
            <h1>üìç Library System</h1>
            <small>Role Tanpa Login</small>
        </div>
        <div class="role-control">
            <label>Masuk Sebagai:</label>
            <select id="role-select" onchange="renderPage()">
                <option value="public">Public (Lihat Saja)</option>
                <option value="user">User (Bisa Pinjam)</option>
                <option value="admin">Admin (CRUD)</option>
            </select>
        </div>
    </header>

    <div id="admin-panel" class="hidden">
        <div id="add-form">
            <h3>Tambah Buku Baru</h3>
            <input type="text" id="new-title" placeholder="Judul Buku">
            <input type="text" id="new-author" placeholder="Penulis">
            <input type="number" id="new-stock" placeholder="Stok" style="width: 80px;">
            <button class="btn btn-add" onclick="addBook()">Simpan Buku</button>
        </div>
    </div>

    <table id="book-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Judul</th>
                <th>Penulis</th>
                <th>Stok</th>
                <th id="action-header">Aksi</th>
            </tr>
        </thead>
        <tbody id="book-list">
            </tbody>
    </table>

    <script>
        const API_URL = '/api/books';
        const BORROW_URL = '/api/borrow';
        
        // Fungsi Utama: Mengatur Tampilan berdasarkan Role
        async function renderPage() {
            const role = document.getElementById('role-select').value;
            const adminPanel = document.getElementById('admin-panel');
            const actionHeader = document.getElementById('action-header');
            
            // 1. Atur Tampilan Admin Panel
            if (role === 'admin') {
                adminPanel.classList.remove('hidden');
                actionHeader.classList.remove('hidden');
            } else if (role === 'user') {
                adminPanel.classList.add('hidden');
                actionHeader.classList.remove('hidden');
            } else {
                // Public
                adminPanel.classList.add('hidden');
                actionHeader.classList.add('hidden');
            }

            // 2. Ambil Data Buku
            loadBooks(role);
        }

        async function loadBooks(role) {
            try {
                const res = await fetch(API_URL);
                const books = await res.json();
                const list = document.getElementById('book-list');
                list.innerHTML = '';

                books.forEach(book => {
                    let actionButtons = '-';

                    // LOGIC TOMBOL BERDASARKAN ROLE
                    if (role === 'admin') {
                        actionButtons = `
                            <button class="btn btn-delete" onclick="deleteBook(${book.id})">Hapus</button>
                        `;
                    } else if (role === 'user') {
                        
                        if(book.stock > 0) {
                            actionButtons = `<button class="btn btn-borrow" onclick="borrowBook(${book.id})">üìç Pinjam Disini</button>`;
                        } else {
                            actionButtons = `<span style="color:red">Habis</span>`;
                        }
                    }

                    // Render Baris
                    const row = `
                        <tr>
                            <td>${book.id}</td>
                            <td><strong>${book.title}</strong></td>
                            <td>${book.author}</td>
                            <td>${book.stock}</td>
                            <td class="${role === 'public' ? 'hidden' : ''}">${actionButtons}</td>
                        </tr>
                    `;
                    list.innerHTML += row;
                });
            } catch (err) {
                alert('Gagal mengambil data buku');
            }
        }

        // fitur user
        function borrowBook(bookId) {
            if (!navigator.geolocation) {
                return alert('Browser tidak support Geolocation');
            }
            
            alert('Sedang mengambil lokasi anda...');
            
            navigator.geolocation.getCurrentPosition(async (position) => {
                const { latitude, longitude } = position.coords;

                try {
                    const res = await fetch(BORROW_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-user-role': 'user',  
                            'x-user-id': '2'       
                        },
                        body: JSON.stringify({ bookId, latitude, longitude })
                    });

                    const result = await res.json();
                    
                    if (res.ok) {
                        alert(`Sukses! Buku dipinjam di Koordinat:\nLat: ${latitude}\nLong: ${longitude}`);
                        renderPage(); // Refresh stok
                    } else {
                        alert('Gagal: ' + result.message);
                    }
                } catch (err) {
                    alert('Error koneksi ke server');
                }
            }, () => {
                alert('Gagal mendeteksi lokasi. Pastikan GPS aktif!');
            });
        }

        // fitur admin add books
        async function addBook() {
            const title = document.getElementById('new-title').value;
            const author = document.getElementById('new-author').value;
            const stock = document.getElementById('new-stock').value;

            if(!title || !author || !stock) return alert('Isi semua data!');

            await fetch(API_URL, {
                method: 'POST',
                headers: { 
                    'Content-Type': 'application/json',
                    'x-user-role': 'admin' // Simulasi Role Admin
                },
                body: JSON.stringify({ title, author, stock })
            });

            // Kosongkan form dan refresh
            document.getElementById('new-title').value = '';
            document.getElementById('new-author').value = '';
            document.getElementById('new-stock').value = '';
            renderPage();
            alert('Buku berhasil ditambahkan!');
        }

        // fitur admin detele books
        async function deleteBook(id) {
            if(!confirm('Yakin hapus buku ini?')) return;

            await fetch(`${API_URL}/${id}`, {
                method: 'DELETE',
                headers: { 'x-user-role': 'admin' }
            });
            renderPage();
        }
        renderPage();
    </script>
</body>
</html>